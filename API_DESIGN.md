# API_DESIGN.md  
CityHelper – REST & Event API Specification (v1)  
_Last updated: 2025-05-28_

---

## 1. Overview

The CityHelper API is **versioned, RESTful, JSON-based** and secured via OAuth 2.1 / JWT.  
It exposes CRUD operations for city data and proxies selected operations to external city services (e.g. NYC 311). The API is generated by FastAPI; an OpenAPI 3.1 document is produced at `/openapi.json` and interactive docs at `/docs`.

---

## 2. Base URL & Versioning

```txt
Production   https://api.cityhelper.ai/api/v1/
Staging      https://staging-api.cityhelper.ai/api/v1/
Local        http://localhost:8000/api/v1/
```

* All paths in this document are relative to `/api/v1/`.
* Backwards-incompatible changes bump the **minor** version (e.g. `/api/v2/`).

---

## 3. Authentication & Authorization

### 3.1 Flows

| Flow | Endpoint(s) | Token lifetime |
|------|-------------|----------------|
| Resource Owner Password | `POST /auth/token` | access 15 min, refresh 14 d |
| Device Code (kiosk / TV) | `POST /auth/device` + `GET /auth/device/{code}` | same |
| Refresh | `POST /auth/refresh` | generates new access & refresh |

Tokens are **JWT** (RS256). Access token travels via `Authorization: Bearer <jwt>`.  
Refresh token is stored as **http-only, Secure, SameSite=strict** cookie `cityhelper_refresh`.

### 3.2 Scopes & Roles

| Scope | Description |
|-------|-------------|
| `citizen` | Basic citizen actions (submit/view requests) |
| `staff`   | Read/modify all service requests & assets |
| `admin`   | Manage integrations, cities, users |

Roles map to scopes via Casbin policies (see `docs/policies`).

---

## 4. Conventions

### 4.1 Media Types

* Requests & responses: `application/json`
* Problem errors: `application/problem+json` (RFC 7807)

### 4.2 Pagination

`GET` collection endpoints accept:

```
?page[number]=1&page[size]=20     # defaults: number=1, size=20 (max 100)
```

Response headers:

```
X-Total-Count: 352
Link: <...page[number]=2>; rel="next", <...page[number]=18>; rel="last"
```

### 4.3 Filtering & Sorting

* Filtering via `filter[field]=value` (multiple allowed, AND semantics)
* Sorting via `sort=field,-otherField` (minus = desc)

### 4.4 Rate Limiting

```
X-RateLimit-Limit: 300
X-RateLimit-Remaining: 257
X-RateLimit-Reset: 1716900000
```

### 4.5 Error Model

```json
{
  "type": "https://api.cityhelper.ai/errors/validation",
  "title": "Validation Failed",
  "status": 422,
  "detail": "latitude must be between -90 and 90",
  "instance": "/service-requests"
}
```

---

## 5. Resources & Endpoints

### 5.1 Service Requests

| Method | Path | Auth | Description |
|--------|------|------|-------------|
| POST | `/service-requests` | citizen | Create new request (also forwards to city 311) |
| GET  | `/service-requests` | citizen/staff | List (filter by `status`, `category`, bbox) |
| GET  | `/service-requests/{id}` | citizen/staff | Retrieve by UUID |
| PATCH| `/service-requests/{id}` | staff | Update local fields (`status`, `assignedTo`, etc.) |
| DELETE | `/service-requests/{id}` | admin | Soft-delete |

#### Data Model – `ServiceRequest`

| Field | Type | Notes |
|-------|------|-------|
| `id` | `uuid` | generated |
| `cityId` | `uuid` | FK → City |
| `externalId` | `string?` | 311 tracking # |
| `category` | `enum` (`POTHOLE`,`NOISE`,…) |
| `description` | `string` |
| `latitude` / `longitude` | `number` |
| `status` | `enum` (`OPEN`,`IN_PROGRESS`,`CLOSED`) |
| `createdAt` / `updatedAt` | `date-time` |
| `citizenContact` | object (`name`, `email?`, `phone?`) |
| `attachments` | array of file URLs |

_Example (create request):_

```json
POST /service-requests
{
  "category": "POTHOLE",
  "description": "Large pothole near crosswalk",
  "latitude": 40.7128,
  "longitude": -74.0060,
  "citizenContact": { "name": "Jane Doe", "email": "jane@example.com" }
}
```

_Response 201 Created:_

```json
{
  "id": "4d1b0c34-1f1a-4fce-9d13-9ef6b1a8f0c5",
  "externalId": "NYC311-2025-0423-1234",
  "status": "OPEN",
  "createdAt": "2025-05-28T14:05:43Z"
}
```

### 5.2 Citizens (optional account)

| Method | Path |
|--------|------|
| POST | `/citizens` |
| GET  | `/citizens/me` |
| PATCH| `/citizens/me` |
| DELETE | `/citizens/me` |

### 5.3 Assets

CRUD for city assets (parks, vehicles, sensors).

```
GET /assets?filter[type]=PARK&bbox=...
```

Data Model includes geoJSON shape.

### 5.4 Events

Public events feed (`/events`) with time range filters.

### 5.5 Cities & Integrations (admin only)

Manage multi-tenant configs.

```
GET /cities
POST /cities
PATCH /cities/{id}
```

Integration endpoints allow rotating API keys:

```
POST /cities/{id}/integrations/nyc311/rotate-key
```

### 5.6 Health & Metrics

* `/health/live` – 200 OK if container up  
* `/health/ready` – checks DB/redis/integrations  
* `/metrics` – Prometheus exposition (protected)

---

## 6. External Service Adapters

### 6.1 NYC 311 Adapter

| Internal Endpoint | Ext. Call | Notes |
|-------------------|-----------|-------|
| `POST /_adapters/nyc311/submit` (internal) | `https://api.nyc.gov/311/v1/requests` | Maps `ServiceRequest` fields to 311 schema. |
| `GET  /_adapters/nyc311/status/{externalId}` | `.../requests/{externalId}` | Polls status. |

* On creation, adapter returns `trackingNumber`; stored in `externalId`.  
* Background job polls every 30 min; updates local status and emits `service_request.updated` event.

### 6.2 Geoclient Adapter

```
GET /_adapters/geoclient/geocode?address=...
→ calls https://maps.nyc.gov/geoclient/v1/search.json?q=...
```

Response cached in Redis 24 h.

---

## 7. Real-Time & Webhooks

### 7.1 WebSocket Feed

`wss://api.cityhelper.ai/ws`  
Topics (JSON lines):

* `service_request.created`
* `service_request.updated`
* `asset.updated`

Auth by same JWT (`Sec-WebSocket-Protocol: bearer,<token>`).

### 7.2 Outbound Webhooks (Admin Config)

Admins can register URLs to receive POST events:

```json
{
  "url": "https://hooks.myservice.com/cityhelper",
  "events": ["service_request.created","service_request.closed"],
  "secret": "hmac-shared-secret"
}
```

Signature header: `X-CityHelper-Signature: sha256=<hex>`.

---

## 8. Error Codes

| HTTP | Code | Description |
|------|------|-------------|
| 400 | `validation_error` | Invalid request body/query |
| 401 | `unauthenticated` | Missing/invalid token |
| 403 | `forbidden` | Insufficient scope |
| 404 | `not_found` | Resource not found |
| 409 | `conflict` | Duplicate resource |
| 422 | `upstream_rejected` | External API validation fail |
| 429 | `rate_limited` | Per-IP or global quota exceeded |
| 502 | `upstream_error` | Downstream city API error |
| 503 | `maintenance` | Planned downtime |

---

## 9. OpenAPI & Codegen

* Source: FastAPI route decorators + Pydantic models.  
* Published JSON at `/openapi.json`, YAML at `/openapi.yaml`.  
* Front-end API client generated via **openapi-typescript** & **orval**.  
* Postman / Insomnia collections auto-exported on CI.

---

## 10. Security Considerations

* **HTTPS only** (HSTS 12 months).  
* CSRF mitigated via same-site cookies & `csrf-token` header.  
* Input sanitisation via Pydantic validators + ORM parameterisation.  
* Rate-limit per user, per IP, and per integration key.  
* Secrets managed in AWS Secrets Manager; never returned via API.  

---

## 11. Change Log (API Only)

| Date | Version | Change |
|------|---------|--------|
| 2025-05-28 | 1.0.0 | Initial specification |

---
